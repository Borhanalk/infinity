# إصلاح مشكلة الدخول إلى صفحة الإدارة

## المشكلة
كانت هناك مشكلة في الدخول إلى صفحة الإدارة (`/admin`) حيث كان النظام لا يسمح بالدخول حتى بعد تسجيل الدخول.

## السبب
المشكلة كانت أن ملف `proxy.ts` موجود لكنه لا يُستخدم كـ middleware في Next.js. Next.js يتطلب ملف `middleware.ts` في الجذر الرئيسي للمشروع.

## الحل المطبق

### 1. إنشاء ملف `middleware.ts`
تم إنشاء ملف `middleware.ts` في الجذر الرئيسي للمشروع لاستبدال `proxy.ts`. هذا الملف:
- يتحقق من وجود token في cookies
- يتحقق من صحة token باستخدام JWT
- يتحقق من وجود المسؤول في قاعدة البيانات
- يعيد التوجيه إلى صفحة تسجيل الدخول إذا لم يكن المستخدم مسجلاً

### 2. تحسين صفحة تسجيل الدخول
- إضافة دعم لـ `returnTo` parameter للعودة إلى الصفحة المطلوبة بعد تسجيل الدخول
- استخدام `useSearchParams` للحصول على returnTo من URL

## كيفية الاستخدام

### تسجيل الدخول:
1. اذهب إلى: `http://localhost:3002/admin/login`
2. أدخل بيانات الدخول:
   - البريد الإلكتروني: `admin@infinity.com`
   - كلمة المرور: `A@123`
3. بعد تسجيل الدخول، سيتم إعادة توجيهك تلقائياً إلى `/admin`

### إذا تم إعادة التوجيه إلى صفحة تسجيل الدخول:
- هذا يعني أن token غير موجود أو غير صالح
- قم بتسجيل الدخول مرة أخرى
- بعد تسجيل الدخول، سيتم حفظ token في cookies لمدة 7 أيام

## الملفات المعدلة:
1. ✅ `middleware.ts` - ملف جديد للتحقق من المصادقة
2. ✅ `app/admin/login/page.tsx` - تحسينات على صفحة تسجيل الدخول

## ملاحظات:
- Token صالح لمدة 7 أيام
- جميع صفحات `/admin/*` محمية وتتطلب تسجيل الدخول
- جميع API routes في `/api/admin/*` محمية وتتطلب تسجيل الدخول
- الصفحات المسموح بها بدون تسجيل دخول:
  - `/admin/login` - صفحة تسجيل الدخول
  - `/admin/logout` - صفحة تسجيل الخروج
  - `/api/admin/auth` - API تسجيل الدخول

## اختبار الحل:
1. تأكد من أن الخادم يعمل: `npm run dev`
2. اذهب إلى: `http://localhost:3002/admin`
3. يجب أن يتم إعادة توجيهك تلقائياً إلى `/admin/login`
4. سجّل الدخول باستخدام البيانات المذكورة أعلاه
5. يجب أن يتم إعادة توجيهك إلى `/admin` بنجاح
